<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>Vikrates - Listen Now</title>
        <meta name = "viewport" content = "width=device-width, initial-scale=1">
        <link rel = "stylesheet" href = "/bootstrap-3.3.4/css/bootstrap.min.css" />
        <link rel = "stylesheet" href = "/font-awesome-4.3.0/css/font-awesome.min.css" />
        <link rel = "stylesheet" href = "/css/style.css" />
        <style>
            #msg_name,#randomizeName{
                text-decoration:underline;
                cursor:pointer;
            }
            .modes {
                padding: 0 2px;
                margin: 0 2px;
                display: inline;
                border: 1px solid black;
                background:white;

            }
            .active{
                background:rgba(0, 0, 255, 0.17);
            }
            #chatLogContainer{
                width:100%;
                padding:5px;
                background:#fff;
                overflow-y:auto;
                height:400px;
            }
            #msg_msg{
                margin-left:5px;
                width: 100%;
                height: 80px;
            }
            #playlist{

                background: white;
                margin-top: 15px;
                min-height: 150px;

            }
            #emptyPlaylist{

                background: white;
                min-height: 150px;

            }
            #emptyPlaylist {
                display: none;
                padding-top: 11px;
                padding-bottom: 11px;
            }
            .playlistControls {
                margin-top: 25px;
                padding: 4px;
                background: white;
                border-bottom: 1px solid grey;
                border-top-left-radius: 7px;
                border-top-right-radius: 7px;
            }
            #currentlyPlaying{
                padding-top: 11px;
                padding-bottom: 11px;
            }
            .message_name {
                display: inline;
                font-weight: 600;
            }

            .message_message{
                display: inline;
                padding-left: 15px;
            }
               .yt-container {
                position: relative;
                padding-bottom: 56.25%; /* 16:9 */
                padding-top: 25px; /* leaves room for the YouTube header  */
                height: 0;
                overflow:hidden;
            }
            .yt-video {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            body{
                background-image:url("/img/listenBackground3.jpg");
                background-attachment: fixed;
                background-size: cover;
            }
            #chatPush{
                height:75px;
            }
            #playlist>.clearfix {
                padding-right: 9px;
                border-bottom: 1px solid grey;
            }
            #currentlyPlaying{
                background:white;
                padding:5px;
                height:75px;
            }
            body {
                padding-top: 10px;
            }
        </style>
    </head>
    <body>

        <div class = "container-fluid">

            <div class = "row">
                <div id = "video_player" class = "col-lg-6 col-lg-offset-1 col-md-6 col-md-offset-1 col-sm-6 col-xs-6 col-xs-offset-1" style = "height: 1000px; ">
                    <nav class="navbar navbar-default">
                        <div class="container-fluid">
                            <!-- Brand and toggle get grouped for better mobile display -->
                            <div class="navbar-header">
                                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                                    <span class="sr-only">Toggle navigation</span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                </button>
                                <a class="navbar-brand" href="#"><i class="fa fa-meh-o"></i>  <span class="light">Vikrate</span> Web Radio</a>
                            </div>

                            <!-- Collect the nav links, forms, and other content for toggling -->
                            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                                <ul class="nav navbar-nav">
                                    <li class="active"><a href="#">Common Room</a></li>
                                    <li><a href="#">Vip Lounge</a></li>


                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Video Quality<span class="caret"></span></a>
                                        <ul class="dropdown-menu" role="menu">
                                            <li><a href="#">Lowest</a></li>
                                            <li class="divider"></li>
                                            <li><a href="#">720</a></li>
                                            <li><a href="#">1080</a></li>
                                            <li class="divider"></li>
                                            <li><a href="#">Best</a></li>
                                        </ul>
                                    </li>
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Settings<span class="caret"></span></a>
                                        <ul class="dropdown-menu" role="menu">
                                            <li class='text-center'>Click to toggle:</li>
                                            <li class="divider"></li>
                                            <li>Video: 
                                                <ul>
                                                    <li>Full</li>
                                                    <li>Controls</li>
                                                    <li>Hidden</li>
                                                    <li>Disabled</li>
                                                </ul>
                                            </li>
                                            <li>Now Playing: 
                                                <ul>
                                                    <li>Visible</li>
                                                    <li>Visible</li>
                                                    <li>Visible</li>
                                                </ul>
                                            </li>
                                            <li>Chat: 
                                                <ul>
                                                    <li>Full</li>
                                                    <li>Mention Alerts Only</li>
                                                    <li>Hidden</li>
                                                </ul>
                                            </li>
                                            <li>Playlist: 
                                                <ul>

                                                    <li>Full</li>
                                                    <li>Next</li>
                                                    <li>Hidden</li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="dropdown">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Popout<span class="caret"></span></a>
                                        <ul class="dropdown-menu" role="menu">
                                            <li class="divider"></li>
                                            <li><a href="#">Chat</a></li>
                                            <li><a href="#">Video</a></li>
                                            <li><a href="#">MicroPlayer</a></li>
                                        </ul>
                                    </li>
                                     <li><a href="/register">Register</a></li>

                                </ul>


                            </div><!-- /.navbar-collapse -->
                        </div><!-- /.container-fluid -->
                    </nav>
                    <!--     <div id='viewerOptions'>
<div class='modes dataSwitchers' data-optionId='videoMode' data-label='Video' data-startIndex='0' data-curIndex=0 data-options='Full|Controls|Hidden|Disabled'>
Video: <button>Full</button> | <button>Controls</button> | <button>Hidden</button> | <button>Disabled</button>
</div>
<button class='modes dataSwitchers' data-optionId='playlistMode' data-label='Playlist' data-startIndex='0' data-curIndex=0 data-options='Full|Next|Hidden'>
Playlist: <button>Full</button> | <button>Next</button> | <button>Hidden</button>
</button>
<div class='modes dataSwitchers' data-optionId='chatMode' data-label='Chat' data-startIndex='0' data-curIndex=0 data-options='Full|Mention Alerts Only|Hidden'>
Chat: <button>Full</button> | <button>Mention Alerts Only</button> | <button>Hidden</button>
</div>
</div>
<div id='viewerOptions'>
<div class='modes'>
Video Popout: open
</div>
<div class='modes'>
Chat Popout: <button>open</button>
</div>
<div class='modes'>
Playlist Popout: <button>open</button>
</div>
<div class='modes'>
MiniPlayer Popout: <button>open</button>
</div>
</div>-->
                    <div class="yt-container">
                        <div id ='player' class="yt-video"></div>
                    </div>
                    <div id='playlistContainer'>
                        <div class='playlistControls'>
                            <input id='newSong' type='text' placeholder='Paste Video Id Here'/>
                            <button id='addNewSong'>add</button><button id='SkipBtn'>Skip</button>
                        </div>
                        <div id='currentlyPlaying' style='display:none'>
                            <p id='nowPlaying_title'>Song Name</p>
                            <p id='nowPlaying_suggester'>Suggester</p>
                        </div>
                        <div id='playlist' style='display:none'>

                        </div>
                        <div id='emptyPlaylist' class='text-center'>
                            <h1><i class="fa fa-meh-o"></i></h1>
                            <h3>No Music in playlist</h3>
                            <h3>Show Me Your Favorite Music</h3>
                            <h4>Auto Playlist Mode</h4>
                        </div>

                    </div>


                </div>
                <div id = "chat_view" class = "col-lg-4 col-lg-offset-1 col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1 col-xs-6 col-xs-offset-1" style = "height: 1000px; background-color: rgba(239, 235, 235, 0.54);">
                    Your Known As <span id='msg_name'></span><span id=''>&lt;-- click your name to set it!</span><span id='randomizeName'>[Randomize]</span>
                    <div id = 'chatLogsContainer'>
                        <div id = 'chatLogContainer'>
                            <div id='chatMotd'></div>
                            <div id='chatHistory'></div>
                            <div id='chatLog'></div>

                            <div id='chatPush'></div>
                        </div>
                        <div id='newMsgContainer'>
                            <textarea id='msg_msg' placeholder='Type your msg and press Enter to send'></textarea>
                        </div>
                        <div class='col-lg-6'>

                        </div>
                        <div class='col-lg-6'>
                            <div id='usersList'>
                                <div id='usersList_header' class='clearfix'>
                                    <span class='pull-left'>Name</span><span class='pull-right' >Status</span>
                                </div>
                                <div class='usersList_row clearfix'>
                                    <span class='pull-left'>User 1</span>
                                    <span class='pull-right'>Online</span>
                                </div>
                                <div class='usersList_row clearfix'>
                                    <span class='pull-left'>User 1</span>
                                    <span class='pull-right'>Online</span>
                                </div>
                                <div class='usersList_row clearfix'>
                                    <span class='pull-left'>User 1</span>
                                    <span class='pull-right'>Online</span>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class = "row">

            </div>

        </div>

    </body>

    <script type = "text/javascript" src = "//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type = "text/javascript" src = "/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script src="/js/title_notifier.js"></script>
    <script src="/js/js.cookie.js"></script>
    <script src="/js/fluidVideo.js"></script>
    <script type = "text/javascript" src = "/js/moment.js"></script>
    <script type = "text/javascript" src = "/js/jquery.linkify.js"></script>
    <script type = "text/javascript" src = "/js/moment.tz.js"></script>
    <script type = "text/javascript" src = "/js/jquery.emojify.js"></script>
    <script type = "text/javascript" src = "/js/common.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script>

        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // 3. This function creates an <iframe> (and YouTube player)
        //    after the API code downloads.
        var player;
        function onYouTubeIframeAPIReady() {
            window.player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: 'CWh3k0ChdEY',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        // 4. The API will call this function when the video player is ready.
        function onPlayerReady(event) {

            window.io.emit('ready',{name:window.name});
            event.target.playVideo();
        }

        // 5. The API calls this function when the player's state changes.
        //    The function indicates that when playing a video (state=1),
        //    the player should play for six seconds and then stop.
        var done = false;
        function onPlayerStateChange(event) {
            console.log(event.data)
            if (event.data==YT.PlayerState.ENDED){
                io.emit('songEndSync');
            }if (event.data== YT.PlayerState.PAUSED){
                window.player.playVideo();
            }

        }
        function stopVideo() {
            player.stopVideo();
        }
        window.io = io.connect()
        window.awayTimer = null;
        window.away = false;
        window.blured = false;
        $(window).on("blur focus", function(e) {
            var prevType = $(this).data("prevType");

            if (prevType != e.type) {   //  reduce double fire issues
                switch (e.type) {
                    case "blur":
                        window.blured = true;
                        if(window.away ==false){
                            if(window.awayTimer==null){
                                console.log('away timer started')
                                window.awayTimer = setTimeout(function(){
                                    console.log('away timer fired')
                                    window.io.emit('away');
                                    window.away = true;
                                    console.log('you are away')
                                },20000)
                            }else{
                                console.log('you switched tabs again...')
                            }
                        }else{
                            console.log('your still away...')
                        }
                        break;
                    case "focus":
                        window.blured = false;
                        titlenotifier.reset();

                        clearTimeout(window.awayTimer);
                        if(window.away == true){
                            window.io.emit('back');
                            console.log('welcome back')
                            window.away = false;
                            window.awayTimer = null;
                        }else{
                            console.log('your back but you appear to have never left O.o...')
                        }
                        break;
                }
            }

            $(this).data("prevType", e.type);
        })
        // Send the ready event.
        $(function() {
            titlenotifier.max(99);
            titlenotifier.set(0);
            function genName(){
                var firstArray = [
                    'Gruff',
                    'Tough',
                    'Drunk',
                    'Sir',
                    '',
                    'Dr.',
                    'Lord',
                    'grave digger'
                ];
                first = firstArray[Math.round(Math.random()*(firstArray.length-1))];
                var middleArray=[
                    'Harri',
                    'Larry',
                    'Bernard',
                    'James',
                    'Roger',
                    'Ariel',
                    'Sarah',
                    'Jessi',
                    'shadow',
                    'umberdance'
                ];
                middle = middleArray[Math.round(Math.random()*(middleArray.length-1))];
                var suffixArray=[
                    'the II',
                    'the III',
                    'the IIth',
                    'the First',
                    'the XXV',
                    'the IIII',
                    'the inbread',
                    'the pirate',
                    'the viking',
                    'the viking lord',
                    'the dirty viking lord',
                    'the shining viking lord',
                    'the true viking lord',
                    'the ultimate viking lord',
                    'the viking prince',
                    'the time travler',
                    'the viking',
                    'the drifter',
                    'the lover'  ,     
                    'the captins wench',
                    'the student',
                    'the teenager',
                    'the drunk',
                    'diggery',
                    'connal',
                    ''

                ];
                suffix = suffixArray[Math.round(Math.random()*(suffixArray.length-1))];
                if(window.initFinished)
                    window.io.emit('newName', first+' '+middle+' '+suffix);
                else{
                    window.name = first+' '+middle+' '+suffix;
                    $('#msg_name').html(window.name);
                }

            }
            window.io.on('user',function(user){
            	console.log('user',user)
                window.name =user.name;
                $('#msg_name').html(window.name)
                Cookies.set('name', window.name);
            })
            $('#msg_name').click(function(){
                window.io.emit('newName',prompt('name here'));
            })
            $('#randomizeName').click(function(){
                genName();
            })

            window.initFinished = false;
            var name = Cookies.get('name');

            if(name==undefined){
                genName();
            }else{
                window.name = name; 
                $('#msg_name').html(window.name)
            }

            window.initFinished=true;
            window.playlist =[];



            function redrawUi(){
                if(window.playlist.length>0){
                    $('#playlist').show();
                    $('#emptyPlaylist').hide();
                    var playlistEle = $('#playlist')
                    playlistEle.empty();
                    for(var i =window.playlist.length-1;i>=0;i--){
                        var ele =  window.playlist[i];
                        console.log(ele);
                        //draw
                        var img = $('<span class="col-lg-4"/>');
                        img.html($('<img src="http://img.youtube.com/vi/'+ele.id+'/3.jpg">'));
                        var name = $('<span class="col-lg-6"/>');
                        name.html(ele.name);
                        var votes = $('<span class="pull-right"/>');
                        var voteWidgetContainer = $('<div class="voteWidgetContainer"/>')
                        
                        var voteWidgetCount = $('<div class="voteWidgetCount"/>').html(ele.votes);
                        
                        voteWidgetContainer.append(voteWidgetCount);
                        var voteWidgetBtn = $('<div class="voteWidgetBtn btn btn-success"/>').html('Vote +1');
                        
                        voteWidgetContainer.append(voteWidgetBtn);
                        votes.html(voteWidgetContainer);

                        var container = $('<div>').append(img).append(name).append(votes).addClass('clearfix');
                        playlistEle.append(container);
                    }
                }else{

                    $('#playlist').hide();
                    $('#emptyPlaylist').show()
                }
            }








            var buttons = {};
            buttons.skip = $('#SkipBtn');
            buttons.pause = $('#player_pause');

            buttons.skip.click(function(){
                window.io.emit('skip'); 
            }); 
            buttons.pause.click(function(){
                window.io.emit('pause'); 
            });


            function getCaret(el) { 
                if (el.selectionStart) { 
                    return el.selectionStart; 
                } else if (document.selection) { 
                    el.focus();
                    var r = document.selection.createRange(); 
                    if (r == null) { 
                        return 0;
                    }
                    var re = el.createTextRange(), rc = re.duplicate();
                    re.moveToBookmark(r.getBookmark());
                    rc.setEndPoint('EndToStart', re);
                    return rc.text.length;
                }  
                return 0; 
            }
            $('#msg_msg').keyup(function (event) {
                if (event.keyCode == 13) {
                    var content = this.value;  
                    var caret = getCaret(this);          
                    if(event.shiftKey){
                        this.value = content.substring(0, caret - 1) + "\n" + content.substring(caret, content.length);
                        event.stopPropagation();
                    } else {
                        var data = {
                            name: $('#msg_name').html(),
                            message:$('#msg_msg').val(),
                        };                        
                        window.io.emit('msg',data); 
                        console.log('emit','msg',data);
                        $('#msg_msg').val('');
                    }
                }
            });

            window.io.on('msg',function(message){
                console.log('message',message);
                var div = $('<div calss="message">');
                var name = $('<div class="message_name"/>');
                name.html(message.name+":");
                var msg = $('<div class="message_message"/>');
                msg.html(message.message);

                msg.emojify();
                div.append(name);
                div.append(msg);
                if(window.blured)
                    titlenotifier.add();
                var chatlog = $('#chatLog');
                chatlog.append(div);


                $('#chatLogContainer').prop({ scrollTop: $('#chatLogContainer').prop("scrollHeight") });

            })

            window.io.on('newName',function(data){
                console.log('newName',data);
                var div = $('<div calss="sysmsg">');
                var name = $('<div class="newUserAnnounce"/>');
                name.html("<strong>"+data.oldName+"</strong> now known as <strong>"+data.name+"</strong>!");
                name.emojify();
                div.append(name);
                if(window.blured)
                    titlenotifier.add();
                $('#chatLog').append(div);
                $('#chatLogContainer').prop({ scrollTop: $('#chatLogContainer').prop("scrollHeight") });
                window.io.emit('userList'); 
            })
            window.io.on('announce',function(announce){
                console.log('announce',announce);
                var div = $('<div calss="sysmsg">');
                var name = $('<div class="newUserAnnounce"/>');
                name.html("HAIL <strong>"+announce.name+"</strong>!");
                name.emojify();
                div.append(name);

                if(window.blured)
                    titlenotifier.add();
                $('#chatLog').append(div);

                $('#chatLogContainer').prop({ scrollTop: $('#chatLogContainer').prop("scrollHeight") });
                window.io.emit('userList');
            });

            window.io.on('newUser',function(announce){
                console.log('announce',announce);
                var div = $('<div calss="sysmsg">');
                var name = $('<div class="changeUserAnnounce"/>');
                name.html(announce.oldname+" now known as: <strong>"+announce.name+"</strong>");
                name.emojify();
                div.append(name);

                if(window.blured)
                    titlenotifier.add();
                $('#chatLog').append(div);
            });



            //motd stuff
            (function(){
                var div = $('<div calss="sysmsg">');
                var motd = $('<div class="MOTD"/>');
                motd.html('<h2>Vikrates Radio</h2>');
                motd.append('<p>Welcome to chat, this is a very beta software<br>set your name by clicking on your current name above chat</p>');
                motd.append('<p>JCDjP4JnpGU<br>4Sx5xOQpzB8<br>fj-10lIrboM<br>9d8SzG4FPyM<br>r7Zy6ieJAHQ</p>');
                motd.emojify();
                div.append(motd);
                $('#chatMotd').html(div);
            })();




			window.noMedia = false;
            window.io.on('NoMedia',function(){
            	if(window.noMedia==false){
            		window.noMedia = true
                	console.log('NoMedia playing playlist')
                	window.player.loadPlaylist({
                    	list:'RDMpS16zVpLpE',
                    	listType:'playlist',
                    	index:Math.round(Math.random()*26)
                	});
                	$('#currentlyPlaying').hide();
            	}
            })
            	




            /* playlist
            playlistContainer
            playlistControls
            newSong*/
            $('#addNewSong').click(function(){
                var songEle = $('#newSong')
                var song = songEle.val();
                songEle.val('');
                window.io.emit('addSong',{id:song,requester: $('#msg_name').html()})
            })
            window.io.on('newQ',function(q){
                console.log('newQ')
                window.playlist = q;
                console.log(q);
                redrawUi();
                $('#currentlyPlaying').show();
                $('#playlist').show();
                $('#emptyPlaylist').hide()
            });
            redrawUi();
            window.io.on('history',function(data) {
                var chatlog = data.chatlog;
                for(var chatlog_i = 0;chatlog_i<chatlog.length;chatlog_i++){
                    var message = chatlog[chatlog_i];
                    var div = $('<div calss="message">');
                    var name = $('<div class="message_name"/>');
                    name.html(message.name+":");
                    var msg = $('<div class="message_message"/>');
                    msg.html(message.msg);

                    msg.emojify();
                    msg.linkify();
                    div.append(name);
                    div.append(msg);
                    var chathistoryele = $('#chatHistory');
                    chathistoryele.append(div);
                    $('#chatLogContainer').prop({ scrollTop: $('#chatLogContainer').prop("scrollHeight") });
                }
            });

            window.io.on('useraway',function(data){
                console.log('useraway',data);
                $('[data-id="'+data.id+'"].user_status').html('Away');
            })
            window.io.on('userback',function(data){
                console.log('userback',data);
                $('[data-id="'+data.id+'"].user_status').html('Online');
            })
            window.onlineUsers = {};
            window.io.on('newUsersList',function(list){
                window.onlineUsers = list;
                console.log('newUsersList',list)
                $('.usersList_row').remove();
                var usersList = $('#usersList');
                for(var user in list){
                    var obj = list[user];
                    var userele = $('<span class="pull-left">').html(obj.name);
                    var statusele = $('<span class="pull-right user_status">').html("Online").attr('data-id',user);
                    var userContainer = $('<div class="usersList_row clearfix">').append(userele).append(statusele);
                    usersList.append(userContainer);
                }
            });
            window.io.on('addSongs',function(){ 
                console.log('NoMedia playing playlist')
                window.player.loadPlaylist({
                    list:'RDMpS16zVpLpE',
                    listType:'playlist',
                    index:Math.round(Math.random()*26)
                });
                $('#emptyPlaylist').show()
                $('#currentlyPlaying').hide();
            })
            window.io.on('CurrentlyPlaying',function(obj){
                window.currentlyPlaying = obj;
                console.log('newCur',obj);
                window.player.loadVideoById(obj.id,obj.seconds,'large');
                $('#nowPlaying_title').html(obj.name);
				$('#nowPlaying_suggester').html(obj.requester.name);

                // window.player.loadVideoById("bHQqvYy5KYo", 5, "large")
            })
            window.io.on('cur',function(obj){
                console.log('cur',obj);
            })
            window.io.on('whois',function(obj){
                console.log('whois',obj.id,'=',window.sessionId,'=',obj.id==window.sessionId);
                if(obj.id==window.sessionId){
                    window.io.emit('here');
                    console.log('Im still here i just closed another window');
                }
            })
            window.io.on('youare',function(id){
                console.log('youare',id);
                window.sessionId = id;
            });
        });
    </script>
</html>